# RootLens - 完全仕様書

## 📋 概要

**RootLens**は、C2PAハードウェア署名とブロックチェーン技術を組み合わせ、AI時代における「現実」の価値を再定義し、保護するプラットフォームです。

### 解決する課題

| 課題 | RootLensの解決策 |
| --- | --- |
| **AI生成コンテンツの氾濫** | C2PA対応カメラのハードウェア署名を検証し、実在性を暗号技術で担保 |
| **証明情報の消失** | ArweaveとSolana cNFTによる永続的な証明データ保存 |
| **権利の乗っ取り** | Arweave ⇄ cNFT の相互リンク設計により改ざん不可能 |
| **中央集権的な検証** | トラストレスな検証モデル - RootLensが消えても検証可能 |
| **収益化手段の欠如** | Solana Payによる直接取引で撮影者に対価を還元 |

### コアコンセプト

**「Root（始祖）がハードウェア署名であれば、編集済みデータも受け入れる」**

- 無加工のみを対象とせず、色調整・トリミング等を行った報道写真やアート作品も対象
- 重要なのは「どんなに加工されていても、その根っこ（Root）がハードウェア署名である」こと

### ターゲットユーザー

| ユーザー層 | ニーズ |
| --- | --- |
| フォトグラファー・ジャーナリスト | 撮影データの真正性証明、収益化 |
| 報道機関 | 情報源の信頼性担保、証明付きメディアの購入 |
| SNSインフルエンサー | 事実を扱うコンテンツの信頼性向上 |
| AI企業 | クリーンな学習データの調達・購入 |

---

## 🏗️ システムアーキテクチャ

### 全体構成

```
┌─────────────────────────────────────────────────────────────────┐
│                        クライアント                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ アップロード     │  │ 証明書ページ     │  │ 購入            │ │
│  │ ・C2PA検証(WASM)│  │ ・Arweave読取り  │  │ ・SolanaPay     │ │
│  │ ・ハッシュ計算   │  │ ・cNFT検証       │  │ ・メールでDLリンク│ │
│  └────────┬────────┘  │ ・相互リンク検証 │  │                 │ │
│           │           │ ・メディア表示   │  │                 │ │
│           │           └────────┬────────┘  └────────┬────────┘ │
└───────────┼───────────────────┼───────────────────┼────────────┘
            │                   │                   │
            ▼                   ▼                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Docker Compose 環境                           │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   Next.js (Frontend)                      │  │
│  │  ・API Routes（ジョブ投入、ステータス確認）                │  │
│  │  ・Presigned URL発行（Private R2）                        │  │
│  │  ・Public Bucket直接アップロード（Manifest・サムネイル）    │  │
│  │  ・購入処理（DB記録、メール送信）                         │  │
│  └──────────────────────┬───────────────────────────────────┘  │
│                         │ Job追加                               │
│                         ▼                                       │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                      Redis                                │  │
│  │              (BullMQ ジョブキュー)                         │  │
│  └──────────────────────┬───────────────────────────────────┘  │
│                         │ Job取得（直列）                       │
│                         ▼                                       │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   Worker (Node.js)                        │  │
│  │  ・次のcNFTアドレス予測（TreeConfig.numMinted参照）        │  │
│  │  ・Arweaveアップロード（Umi + Irys）                      │  │
│  │  ・cNFT mint（Arweave URI設定）                           │  │
│  │  ・concurrency: 1 で完全直列処理                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│      ┌───────────────┬───────────────┬───────────────┐          │
│      ▼               ▼               ▼               ▼          │
│  ┌────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │
│  │   R2   │  │  Arweave    │  │   Solana    │  │  Supabase  │  │
│  │2バケット│  │ (via Irys)  │  │   cNFT     │  │  DB+Cache  │  │
│  │Private │  │ 証明データ   │  │ (BubbleGum)│  │            │  │
│  │+ Public│  │(永久保存)    │  │            │  │            │  │
│  └────────┘  └─────────────┘  └─────────────┘  └────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 技術スタック

| レイヤー | 技術 | 選定理由 |
| --- | --- | --- |
| Frontend | Next.js 16 (App Router) | React Server Components、API Routes統合 |
| Blockchain | Solana (BubbleGum/Metaplex) | cNFTによる低コスト大量mint |
| 永久保存 | Arweave (via Irys) | 永久保存、Umi統合、SOL払い |
| Storage | Cloudflare R2 (2バケット) | Egress無料、Private+Public構成 |
| Database | Supabase (PostgreSQL + pgvector) | DB + ベクトル検索 |
| C2PA | c2pa-rs (WASM) | ブラウザ上でのC2PA検証 |
| Auth | Privy | ウォレット + SMS + Email認証 |
| 決済 | SolanaPay | 直接送金、手数料最小化 |
| RPC | Helius | cNFT読み取り、DAS API |
| ジョブキュー | BullMQ + Redis | 直列処理、リトライ、スケーラブル |
| コンテナ | Docker Compose | 開発・本番環境の統一 |

### トラストモデル

```
┌─────────────────────────────────────────────────────────────────┐
│                    信頼の構造                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  【信頼する必要があるもの】                                       │
│  ├─ C2PA仕様（暗号技術）                                         │
│  ├─ ハードウェアメーカーのRoot CA（Sony, Google等）               │
│  ├─ Solanaブロックチェーン                                       │
│  └─ Arweaveネットワーク                                          │
│                                                                 │
│  【RootLensサーバーの役割】                                       │
│  ├─ 証明書ページでの表示（サーバーを信頼）                        │
│  │   → manifest.jsonの内容は信頼が必要                           │
│  │   → ただし元ファイル自体はC2PA署名により改ざん不可能           │
│  │                                                               │
│  ├─ Arweaveアップロード時のウォレット署名                         │
│  │   → 「正規のRootLensから発行された」ことの証明                 │
│  │   → Irys Explorerでウォレットアドレスを確認可能               │
│  │                                                               │
│  └─ 次のcNFTアドレス予測                                         │
│     → TreeConfig.numMintedを読み取り、leaf indexを決定           │
│     → PDA計算は誰でも検証可能                                    │
│     → 直列処理により競合を完全に防止                             │
│                                                                 │
│  【購入後のトラストレス検証】                                     │
│  ├─ 元ファイルにC2PA署名が埋め込まれている                       │
│  ├─ ファイルをダウンロードしてc2pa-rsで検証可能                 │
│  ├─ Root署名者、証明書チェーン、ハッシュ値をすべて検証可能        │
│  └─ RootLensが消えても、元ファイルの真正性は保証される            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### データの役割分担

| データ種別 | 保存先 | 理由 |
| --- | --- | --- |
| 証明データ（ハッシュ、署名者等） | Arweave (via Irys) | 永久保存、不変、トラストレス |
| サムネイル画像 | R2 Public Bucket | 公開URL、削除可能 |
| C2PAメタデータ（manifest.json） | R2 Public Bucket | 公開URL、証明書ページで使用 |
| 元メディアファイル | R2 Private Bucket | Presigned URLのみ、販売対象 |
| 所有権（cNFT） | Solana | 譲渡可能、検証可能 |
| ビジネスデータ | Supabase | 可変、サービス固有 |
| ジョブキュー | Redis | 直列処理、リトライ管理 |

---

## 📁 データモデル

### Arweave構造（証明データの永久保存）

**Arweaveに保存するJSONメタデータ：**

```json
{
  "name": "RootLens Proof #abc123ef",
  "symbol": "RLENS",
  "description": "Media authenticity proof verified by RootLens",
  "image": "https://pub-xxxxx.r2.dev/media/abc123.../thumbnail.jpg",
  "target_asset_id": "7xKp...3mNv",
  "attributes": [
    { "trait_type": "original_hash", "value": "abc123ef..." },
    { "trait_type": "root_signer", "value": "Sony Corporation" },
    { "trait_type": "root_cert_chain", "value": "Base64エンコードされた証明書チェーン" },
    { "trait_type": "created_at", "value": "2025-01-15T12:00:00Z" }
  ]
}
```

**フィールド詳細：**

| フィールド | 内容 | サイズ | 用途 |
| --- | --- | --- | --- |
| `name` | 証明書の名前 | 50 bytes | 識別用 |
| `symbol` | シンボル（RLENS） | 10 bytes | 識別用 |
| `description` | 説明文 | 100 bytes | 説明 |
| `image` | サムネイル公開URL | 100 bytes | R2 Public Bucketへのリンク |
| `target_asset_id` | cNFTアドレス | 44 bytes | 相互リンク検証 |
| `original_hash` | 元ファイルのSHA-256 | 64 bytes | ファイル検証 |
| `root_signer` | Root CA名 | 50-100 bytes | 署名者表示・検索 |
| `root_cert_chain` | 証明書チェーン（Base64） | 1-3 KB | C2PA署名検証 |
| `created_at` | タイムスタンプ | 30 bytes | 発行日時 |

**特徴：**
- サムネイルはR2 Public URLとして保存（削除可能）
- 証明データは最小限（3-5KB）
- Irys Explorerでウォレットアドレスを確認可能

### cNFT構造（Solana / BubbleGum）

```json
{
  "name": "RootLens Proof #abc123ef",
  "symbol": "RLENS",
  "uri": "https://gateway.irys.xyz/xyz..."
}
```

**cNFTには最小限の情報のみ。詳細はArweave URIを参照。**

### 相互リンクによる証明の真正性定義

```
┌─────────────────────────────────────────────────────────────────┐
│                  「真の証明データ」の定義                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  以下の条件をすべて満たすArweaveデータを「真の証明」とする：      │
│                                                                 │
│  1. Irys Explorerで、トランザクションの発行者が                 │
│     RootLensの公開ウォレットアドレスと一致する                   │
│                                                                 │
│  2. 同一original_hashを持つArweaveデータの中で、               │
│     target_asset_idに記載されたcNFTが最も古い                   │
│                                                                 │
│  3. そのcNFTのURIがこのArweaveデータを指している                 │
│     （相互リンクの成立）                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**攻撃シナリオと防御：**

| 攻撃 | 防御 |
| --- | --- |
| 先にコピーArweaveデータを作成 | Irys Explorerで発行者ウォレットを確認 → RootLensでない |
| 先にコピーcNFTを作成 | Arweaveのtarget_asset_idと一致しないため無効 |
| 正規cNFTをBurnして乗っ取り | Arweaveのtarget_asset_idは永久記録。新規mintしても相互リンクが成立しない |
| 同時リクエストで競合 | BullMQ concurrency:1 で完全直列化。競合不可 |

### R2ストレージ構造（2バケット構成）

#### Private Bucket（元データ専用）

```
media/{original_hash}/
└── original.{ext}          # 元メディアファイル（C2PA署名埋め込み済み）
```

- **アクセス**: Presigned URLのみ（購入者のみ、期限付き）
- **用途**: 販売対象、購入後の完全検証用
- **削除可能**: はい（GDPR対応、違法コンテンツ削除）

#### Public Bucket（公開データ）

```
media/{original_hash}/
├── thumbnail.jpg           # サムネイル画像（50-200KB）
└── manifest.json           # C2PAメタデータ（50-500KB）
```

- **アクセス**: 公開URL（誰でもアクセス可能）
- **用途**: 証明書ページでの表示
- **削除可能**: はい（プライバシー保護）

**manifest.json の内容：**

```json
{
  "activeManifest": {
    "claim_generator": "Sony ILCE-7M4 1.0",
    "signature_info": {
      "issuer": "Sony Corporation",
      "cert_chain": ["-----BEGIN CERTIFICATE-----...", ...],
      "time": "2024-12-01T15:30:00Z"
    },
    "assertions": [
      {
        "label": "stds.exif",
        "data": { "exif:Make": "Sony", "exif:Model": "ILCE-7M4", ... }
      },
      {
        "label": "stds.iptc",
        "data": { "Caption": "富士山の夕焼け", ... }
      },
      {
        "label": "creative.thumbnail",
        "data": "data:image/jpeg;base64,/9j/4AAQ..."
      }
    ]
  },
  "validationStatus": { "isValid": true, "errors": [] },
  "thumbnailUrl": "data:image/jpeg;base64,/9j/4AAQ..."
}
```

**重要**: manifest.jsonにはData URIとしてサムネイルが含まれていますが、証明書ページではR2 Public BucketのURLから別途読み込みます。

### Supabaseスキーマ

#### media_proofs テーブル（ビジネスデータ + キャッシュ）

```sql
CREATE TABLE media_proofs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Arweave連携
    arweave_tx_id TEXT NOT NULL UNIQUE,

    -- cNFT連携
    cnft_mint_address TEXT NOT NULL UNIQUE,
    owner_wallet TEXT NOT NULL,

    -- R2パス導出用
    original_hash TEXT NOT NULL UNIQUE,
    file_extension TEXT NOT NULL,

    -- RootLens独自データ
    price_lamports BIGINT DEFAULT 0,
    title TEXT,
    description TEXT,

    -- 状態管理
    is_deleted BOOLEAN DEFAULT FALSE,

    -- タイムスタンプ
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**設計思想**: すべての証明データはArweaveに保存。Supabaseはビジネスロジック専用（価格、タイトル、状態管理のみ）

#### purchases テーブル

```sql
CREATE TABLE purchases (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    media_proof_id UUID NOT NULL REFERENCES media_proofs(id),
    buyer_wallet TEXT NOT NULL,
    buyer_email TEXT NOT NULL,
    solana_tx_signature TEXT NOT NULL,
    amount_lamports BIGINT NOT NULL,
    seller_wallet TEXT NOT NULL,
    download_token TEXT NOT NULL UNIQUE,
    download_expires_at TIMESTAMPTZ NOT NULL,
    download_count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### users テーブル（Privy連携）

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    privy_user_id TEXT NOT NULL UNIQUE,
    wallet_address TEXT NOT NULL,
    email TEXT NOT NULL,
    phone TEXT,
    display_name TEXT,
    bio TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### feature_vectors テーブル（Lens機能用）

```sql
CREATE TABLE feature_vectors (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    media_proof_id UUID NOT NULL REFERENCES media_proofs(id),
    embedding vector(512),
    model_name TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 🔄 ユーザーフロー

### アップロードフロー

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: Privy認証                                              │
│  ├─ ウォレット接続                                               │
│  ├─ SMS認証（オプション）                                        │
│  └─ Email認証（オプション）                                      │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: ファイル選択                                            │
│  ユーザーがC2PA付きメディアをドラッグ＆ドロップ                    │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 3: クライアントサイドC2PA検証（WASM）                       │
│  ├─ c2pa.read(file) でManifest Storeを解析                      │
│  ├─ Ingredientsを再帰的に遡り、Rootを特定                        │
│  ├─ Root署名証明書が信頼済みリスト（ハードウェアCA）に含まれるか確認│
│  ├─ root_signer（CA名）を抽出                                   │
│  ├─ 証明書チェーン（cert_chain）をBase64エンコード               │
│  ├─ サムネイルをData URIに変換                                  │
│  └─ 検証失敗 → エラー表示、アップロード不可                       │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 4: プライバシー警告表示                                    │
│  ├─ C2PAメタデータに含まれる情報を一覧表示                        │
│  │   （GPS、シリアル番号、撮影日時等）                           │
│  ├─ 「これらの情報が公開されます」と警告                          │
│  └─ ユーザーが続行を選択                                         │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 5: 価格・情報設定                                          │
│  ├─ 価格を設定（0 = 無料ダウンロード）                           │
│  ├─ タイトル（オプション）                                       │
│  └─ 説明文（オプション）                                         │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 6: クライアントサイドでハッシュ計算                         │
│  └─ 元メディアファイルのSHA-256ハッシュ（= original_hash）        │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 7: 重複チェック（API経由）                                 │
│  ├─ original_hashがすでにSupabaseに存在するか確認               │
│  └─ 存在する場合 → エラー表示、アップロード不可                   │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 8: R2アップロード（2段階）                                 │
│                                                                 │
│  【8-1】Private Bucketへ元ファイルアップロード                   │
│  ├─ POST /api/upload/presigned でPresigned URL取得             │
│  ├─ original.{ext} をPUTでアップロード                          │
│  └─ パス: media/{hash}/original.{ext}                          │
│                                                                 │
│  【8-2】Public Bucketへmanifest・サムネイルアップロード           │
│  ├─ POST /api/upload/public を呼び出し                         │
│  ├─ サーバー側でthumbnail.jpg をアップロード                    │
│  ├─ サーバー側でmanifest.json をアップロード                    │
│  └─ 公開URLを取得                                               │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 9: Mintジョブを投入                                        │
│  ├─ POST /api/upload で以下のデータを送信:                      │
│  │   - userWallet                                              │
│  │   - originalHash                                            │
│  │   - rootSigner                                              │
│  │   - rootCertChain (Base64)                                  │
│  │   - mediaFilePath                                           │
│  │   - thumbnailPublicUrl                                      │
│  │   - price, title, description                               │
│  ├─ BullMQのキューにジョブを追加                                 │
│  └─ ユーザーに「処理中」と即座にレスポンス                        │
└─────────────────────────────────────────────────────────────────┘
                                ↓
        ┌─────────────────────────────────────────────────────────┐
        │  【Worker側で直列処理】                                  │
        │                                                         │
        │  Step 10: 既存チェック（冪等性担保）                     │
        │  └─ Supabaseでoriginal_hashを検索                       │
        │                                                         │
        │  Step 11: 次のcNFTアドレス予測                          │
        │  ├─ TreeConfig.numMintedを取得                          │
        │  ├─ 次のleaf indexを決定                                │
        │  └─ PDAを計算してAsset IDを予測                          │
        │                                                         │
        │  Step 12: Arweaveアップロード（Umi + Irys）              │
        │  ├─ 証明データJSONを作成:                                │
        │  │   - target_asset_id: 予測したcNFTアドレス            │
        │  │   - image: サムネイル公開URL                         │
        │  │   - attributes: ハッシュ、署名者、証明書チェーン等    │
        │  └─ umi.uploader.uploadJson()                           │
        │                                                         │
        │  Step 13: cNFT mint                                     │
        │  ├─ Metaplex BubbleGum SDKでcNFTをmint                  │
        │  ├─ uri: Arweave URI                                    │
        │  └─ 予測IDと実際のIDの一致を確認                         │
        │                                                         │
        │  Step 14: Supabaseに保存                                │
        │  └─ media_proofsテーブルに記録                          │
        └─────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 15: 完了通知                                               │
│  ├─ フロントエンドでジョブステータスをポーリング                  │
│  ├─ 証明書ページURLを表示                                        │
│  ├─ URLコピーボタン                                              │
│  └─ SNSシェアボタン                                              │
└─────────────────────────────────────────────────────────────────┘
```

### 証明書ページ（ビューワー）

**URL形式**: `rootlens.io/proof/{original_hash}`

#### 表示内容

```
┌─────────────────────────────────────────────────────────────────┐
│  RootLens - 真贋証明書                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │              [サムネイルプレビュー]                         │ │
│  │        (R2 Public Bucketから直接読み込み)                  │ │
│  │                                                           │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ■ タイトル・説明                                               │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  [ユーザーが設定したタイトル]                             │ │
│  │  [ユーザーが設定した説明文]                               │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ■ 検証ステータス                                               │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  ✅ 相互リンク検証済み                                     │ │
│  │  Arweave: ar://xyz...                                     │ │
│  │  cNFT: 7xKp...3mNv                                        │ │
│  │  発行日時: 2025-01-15 12:00 UTC                           │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ■ C2PA情報（manifest.jsonから）                                │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  🔒 ハードウェア署名済み                                   │ │
│  │  デバイス: Sony A7IV                                      │ │
│  │  証明書発行元: Sony Corporation                           │ │
│  │  信頼済みリスト: ✅ RootLens Trust List に含まれる         │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ■ 来歴（Provenance Chain）                                     │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  📷 撮影        →  🎨 編集        →  📤 登録              │ │
│  │  Sony A7IV         Lightroom          RootLens            │ │
│  │  2024-11-28        色調整・トリミング   2025-01-15         │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ■ 所有者・価格                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  所有者: 7xKp...3mNv                                      │ │
│  │  価格: 0.5 SOL                                            │ │
│  │                                                           │ │
│  │  [💰 購入してダウンロード]                                 │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 検証フロー

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: ページアクセス                                          │
│  URLからoriginal_hashを取得                                      │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: Supabaseから基本情報取得                                │
│  └─ arweave_tx_id, cnft_mint_address, title, price等            │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 3: Arweaveから証明データ取得                               │
│  ├─ GET https://gateway.irys.xyz/{arweave_tx_id}                │
│  └─ 取得: original_hash, root_signer, root_cert_chain等         │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 4: Public Bucketからmanifest.json取得                     │
│  ├─ GET {PUBLIC_BUCKET_URL}/media/{hash}/manifest.json          │
│  └─ 取得: C2PA詳細データ、サムネイル（Data URI）                 │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 5: 相互リンク検証（簡易版）                                │
│  └─ arweaveData.target_asset_id === dbData.cnft_mint_address    │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 6: 証明書ページ表示                                        │
│  ├─ サムネイル表示（Public Bucket URL）                         │
│  ├─ C2PA情報表示（manifest.jsonから）                           │
│  ├─ ブロックチェーン情報表示（Arweave + cNFT）                  │
│  └─ 購入ボタン表示                                              │
└─────────────────────────────────────────────────────────────────┘
```

**注意**: 現在の実装は簡易版の相互リンク検証のみ。完全版（cNFT側のURIも確認）は今後実装予定。

### 購入フロー（SolanaPay）

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: 証明書ページで「購入」ボタンをクリック                  │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: Privy認証確認                                           │
│  ├─ 未ログイン → ログインプロンプト表示                          │
│  └─ ログイン済み → 次へ                                          │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 3: メールアドレス入力                                      │
│  └─ ダウンロードリンク送付先                                     │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 4: SolanaPay決済                                           │
│  ├─ 所有者ウォレットへ送金トランザクション作成                   │
│  ├─ ウォレットで署名                                             │
│  └─ トランザクション送信                                         │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 5: サーバー側で購入記録                                    │
│  ├─ トランザクション署名を検証                                   │
│  ├─ purchasesテーブルに記録                                      │
│  │   - buyer_wallet, buyer_email                               │
│  │   - solana_tx_signature                                     │
│  │   - download_token（UUID生成）                              │
│  │   - download_expires_at（24時間後）                         │
│  └─ メール送信（Resend）                                         │
│     - ダウンロードURL: /download/{download_token}               │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 6: メール受信・ダウンロード                                │
│  ├─ ユーザーがメール内のリンクをクリック                         │
│  ├─ GET /download/{download_token}                              │
│  ├─ トークン検証（有効期限、使用回数）                           │
│  ├─ Presigned URL生成（Private Bucket）                         │
│  │   - media/{hash}/original.{ext}                             │
│  │   - 有効期限: 1時間                                          │
│  └─ リダイレクトでダウンロード開始                               │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 7: 購入後の完全検証（ユーザー側）                          │
│  ├─ c2pa.read(file) でC2PA検証                                  │
│  ├─ Root署名者を確認                                             │
│  ├─ 証明書チェーンを確認                                         │
│  └─ トラストレスな真正性確認完了                                 │
└─────────────────────────────────────────────────────────────────┘
```

**実装状況**: 未実装（必須機能）

---

## 🔍 Lens機能（画像検索）

### 概要

CLIP（Contrastive Language-Image Pre-Training）モデルを使用して、アップロードされた画像の特徴量ベクトルを抽出し、類似画像検索を実現します。

### アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│  アップロード時                                                  │
│                                                                 │
│  元ファイル → CLIP Encoder → 特徴量ベクトル（512次元）           │
│                                  ↓                              │
│                         Supabase (pgvector)                     │
│                         feature_vectors テーブル                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  検索時                                                          │
│                                                                 │
│  検索クエリ（画像 or テキスト） → CLIP Encoder                   │
│                                         ↓                        │
│                                  クエリベクトル                   │
│                                         ↓                        │
│                    pgvector コサイン類似度検索                    │
│                                         ↓                        │
│                            類似画像トップN件                      │
└─────────────────────────────────────────────────────────────────┘
```

### 処理フロー

#### 特徴量抽出（アップロード時）

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: cNFT mint完了後                                         │
│  └─ Worker内で特徴量抽出ジョブを追加                             │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: R2から元ファイルを取得                                  │
│  └─ Private Bucketから media/{hash}/original.{ext} を取得        │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 3: CLIPモデルで特徴量抽出                                  │
│  ├─ Python環境でCLIPモデルをロード                               │
│  ├─ 画像を前処理（リサイズ、正規化）                             │
│  └─ encode_image() → 512次元ベクトル                            │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 4: Supabaseに保存                                          │
│  └─ feature_vectors テーブルに挿入                               │
│     - media_proof_id: 対象のProof ID                            │
│     - embedding: 特徴量ベクトル（pgvector型）                    │
│     - model_name: "openai/clip-vit-base-patch32"                │
└─────────────────────────────────────────────────────────────────┘
```

#### 類似画像検索

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: ユーザーが検索クエリを入力                              │
│  ├─ 画像アップロード（類似画像を探す。モバイルの場合はGoogleLensを意識 ） │
│  └─ テキスト入力（自然言語でコンテンツを探す）                   │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: クエリをCLIPで特徴量ベクトル化                          │
│  ├─ 画像の場合: encode_image()                                  │
│  └─ テキストの場合: encode_text()                               │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 3: pgvectorでコサイン類似度検索                            │
│  ```sql                                                         │
│  SELECT media_proof_id,                                         │
│         1 - (embedding <=> query_vector) AS similarity          │
│  FROM feature_vectors                                           │
│  ORDER BY embedding <=> query_vector                            │
│  LIMIT 20;                                                      │
│  ```                                                            │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 4: 結果表示                                                │
│  ├─ 類似度スコアとともに証明書カードを表示                        │
│  ├─ サムネイル、タイトル、root_signer等を表示                    │
│  └─ クリックで証明書ページへ遷移                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 技術選定

| 項目 | 技術 | 理由 |
| --- | --- | --- |
| モデル | OpenAI CLIP (ViT-B/32) | マルチモーダル（画像+テキスト）検索可能 |
| ベクトルDB | Supabase pgvector | 既存DBに統合、コサイン類似度検索 |
| インデックス | IVFFlat | 高速な近似最近傍探索 |
| Python環境 | Docker コンテナ | Worker環境と分離 |

### UI設計

```
┌─────────────────────────────────────────────────────────────────┐
│  Lens - 類似画像検索                                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [🔍 検索バー]                                                   │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  「富士山」と入力 or 画像をドロップ                         │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  【検索結果】                                                    │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                             │
│  │ 📷  │ │ 📷  │ │ 📷  │ │ 📷  │                             │
│  │富士山│ │富士山│ │富士山│ │富士山│                             │
│  │98%  │ │95%  │ │92%  │ │89%  │                             │
│  └─────┘ └─────┘ └─────┘ └─────┘                             │
│                                                                 │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                             │
│  │ 📷  │ │ 📷  │ │ 📷  │ │ 📷  │                             │
│  │富士山│ │富士山│ │富士山│ │富士山│                             │
│  │85%  │ │82%  │ │78%  │ │75%  │                             │
│  └─────┘ └─────┘ └─────┘ └─────┘                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**実装状況**: 未実装（必須機能）

---

## 🔧 cNFTアドレス予測ロジック

### 技術的背景

cNFTのAsset IDは、Merkle TreeのアドレスとLeaf Indexから導出されるPDA（Program Derived Address）です。

```typescript
// PDA導出の仕組み
const [assetId, bump] = await PublicKey.findProgramAddress(
  [
    Buffer.from("asset"),
    merkleTree.toBuffer(),
    leafIndex.toArrayLike(Buffer, 'le', 8),
  ],
  MPL_BUBBLEGUM_PROGRAM_ID
);
```

### 予測のためのステップ

```typescript
import { fetchTreeConfigFromSeeds, findLeafAssetIdPda } from '@metaplex-foundation/mpl-bubblegum';

async function predictNextAssetId(umi: Umi, merkleTree: PublicKey) {
  // 1. TreeConfigからnum_mintedを取得
  const treeConfig = await fetchTreeConfigFromSeeds(umi, { merkleTree });

  // 2. 次のleaf indexはnum_minted（0-indexed）
  const nextLeafIndex = treeConfig.numMinted;

  // 3. Asset IDを事前計算
  const [predictedAssetId] = await findLeafAssetIdPda(umi, {
    merkleTree,
    leafIndex: nextLeafIndex
  });

  return {
    predictedAssetId: predictedAssetId.toString(),
    nextLeafIndex: nextLeafIndex
  };
}
```

### 直列処理による競合防止

**なぜ直列処理が必要か：**

```
┌─────────────────────────────────────────────────────────────────┐
│  並列処理の場合（危険）                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  User A ─┬─ numMinted=100を読む ─┬─ ID予測=Asset#100           │
│          │                       │                              │
│  User B ─┴─ numMinted=100を読む ─┴─ ID予測=Asset#100 ← 重複！  │
│                                                                 │
│  → 両方がAsset#100を予測してArweaveにアップロード               │
│  → 一方のmintが失敗、または相互リンクが壊れる                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  直列処理の場合（安全）                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  User A ─── numMinted=100 ─── ID予測=Asset#100 ─── mint完了    │
│                                              │                  │
│  User B ─── (待機中) ─────────────────────────┘                 │
│         └── numMinted=101 ─── ID予測=Asset#101 ─── mint完了    │
│                                                                 │
│  → 完全に順番通り。競合なし。                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🛡️ セキュリティ

### アクセス制御

| リソース | アクセス |
| --- | --- |
| 証明書ページ | パブリック（誰でも閲覧可） |
| Arweaveデータ | パブリック（誰でも読める） |
| cNFTデータ | パブリック（ブロックチェーン） |
| R2 Public Bucket（manifest、サムネイル） | パブリック（公開URL） |
| R2 Private Bucket（元ファイル） | プライベート（Presigned URLのみ） |
| Redisキュー | プライベート（Docker内部ネットワーク） |

### サーバー公開鍵の管理

```
┌─────────────────────────────────────────────────────────────────┐
│  RootLensサーバーウォレット管理                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  【公開鍵】                                                      │
│  ├─ Irys Explorerでトランザクション発行者として記録される        │
│  └─ 公開情報として誰でも検証可能                                │
│                                                                 │
│  【秘密鍵】                                                      │
│  ├─ Workerコンテナのみが保持                                    │
│  ├─ 環境変数経由で注入（JSON配列形式）                          │
│  ├─ 本番環境ではHSM等での保護を推奨                             │
│  └─ 鍵のローテーション計画を策定                                │
│                                                                 │
│  【鍵漏洩時の対応】                                              │
│  ├─ 新しい鍵ペアを生成                                          │
│  ├─ 旧公開鍵を「失効」リストに追加                              │
│  └─ 検証ロジックで失効リストを参照                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 違法コンテンツ対応

```
┌─────────────────────────────────────────────────────────────────┐
│  違法コンテンツが報告された場合                                  │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: R2からファイルを削除                                    │
│  ├─ Private Bucket: original.{ext}                              │
│  ├─ Public Bucket: thumbnail.jpg, manifest.json                 │
│  └─ → ダウンロード不可、証明書ページでサムネイル非表示           │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: DBのis_deletedフラグを立てる                            │
│  └─ 証明書ページで「削除済み」と表示                              │
└─────────────────────────────────────────────────────────────────┘

【Arweave/cNFTについて】
- 削除できない（技術的制約）
- ただし、Arweaveには違法コンテンツ自体は含まれない（メタデータのみ）
- cNFTも同様（URIのみ）
- むしろ、アップロードした人物の特定に使用可能（証拠として残る）
```

---

## ⚙️ 環境変数

```bash
# ===== Privy (認証) =====
NEXT_PUBLIC_PRIVY_APP_ID=

# ===== Supabase (データベース) =====
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# ===== Cloudflare R2 (ストレージ) =====
R2_ACCOUNT_ID=
R2_ACCESS_KEY_ID=
R2_SECRET_ACCESS_KEY=
R2_BUCKET_NAME=rootlens-media              # Private bucket
R2_PUBLIC_BUCKET_NAME=rootlens-public      # Public bucket
R2_PUBLIC_BUCKET_URL=https://pub-xxxxx.r2.dev
NEXT_PUBLIC_R2_PUBLIC_BUCKET_URL=https://pub-xxxxx.r2.dev

# ===== Redis (Docker内部) =====
REDIS_HOST=redis
REDIS_PORT=6379

# ===== Solana =====
SOLANA_RPC_URL=https://api.devnet.solana.com
SOLANA_PRIVATE_KEY=                        # JSON配列形式: [1,2,3,...]

# ===== Metaplex (Merkle Tree) =====
MERKLE_TREE_ADDRESS=

# ===== Helius (DAS API) =====
HELIUS_API_KEY=

# ===== Irys (Arweaveアップロード) =====
IRYS_ADDRESS=https://devnet.irys.xyz       # devnet
# IRYS_ADDRESS=https://node1.irys.xyz      # mainnet

# ===== ビューワー =====
NEXT_PUBLIC_ARWEAVE_GATEWAY=https://gateway.irys.xyz
NEXT_PUBLIC_ARWEAVE_EXPLORER_URL=https://devnet.irys.xyz/tx
NEXT_PUBLIC_SOLANA_EXPLORER_URL=https://orb.helius.dev/address

# ===== App URL =====
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

---

## 📦 使用SDK・ライブラリ

| 用途 | ライブラリ |
| --- | --- |
| フロントエンド | Next.js 16 (App Router) |
| 認証 | @privy-io/react-auth |
| C2PA | c2pa-rs (WASM) |
| Solana | @solana/web3.js |
| cNFT | @metaplex-foundation/mpl-bubblegum |
| Umi | @metaplex-foundation/umi |
| Arweave | @metaplex-foundation/umi-uploader-irys |
| SolanaPay | @solana/pay |
| DB | @supabase/supabase-js |
| ジョブキュー | bullmq, ioredis |
| メール | Resend |
| UI | Radix UI, Tailwind CSS |

---

## 🗂️ ディレクトリ構成

```
root/
├── docker-compose.yml        # 全体の起動管理
├── .env.example              # 環境変数テンプレート
├── supabase-schema-v4.sql    # Supabaseスキーマ
├── SPECS.md                  # 本仕様書
├── frontend/                 # Next.js (Producer: ジョブを追加する側)
│   ├── app/
│   │   ├── api/
│   │   │   ├── upload/
│   │   │   │   ├── route.ts              # ジョブ投入API
│   │   │   │   ├── presigned/route.ts    # Presigned URL発行
│   │   │   │   └── public/route.ts       # Public Bucket直接アップロード
│   │   │   ├── job-status/[jobId]/route.ts  # ジョブステータス確認
│   │   │   └── download/[token]/route.ts    # 購入後ダウンロード
│   │   ├── proof/[originalHash]/page.tsx # 証明書ページ
│   │   ├── upload/page.tsx               # アップロードページ
│   │   ├── lib/
│   │   │   ├── r2.ts                     # R2操作（2バケット対応）
│   │   │   ├── queue.ts                  # BullMQ Queue設定
│   │   │   ├── supabase.ts               # Supabaseクライアント
│   │   │   └── c2pa-parser.ts            # C2PA解析ヘルパー
│   │   └── components/                   # UIコンポーネント
│   ├── package.json
│   └── Dockerfile
├── worker/                   # Node.js (Consumer: ジョブを処理する側)
│   ├── src/
│   │   ├── worker.ts         # BullMQ Worker設定
│   │   ├── processor.ts      # Mint処理ロジック（6ステップ）
│   │   └── lib/
│   │       ├── solana.ts     # Solana/cNFT関連
│   │       ├── cnft.ts       # cNFT mint処理
│   │       ├── arweave.ts    # Arweave/Irys関連
│   │       └── database.ts   # Supabase保存処理
│   ├── package.json
│   └── Dockerfile
├── shared/                   # 共有コード（型定義等）
│   └── types/
│       ├── index.ts
│       ├── job.ts            # MintJobData, MintJobResult
│       └── proof.ts          # ArweaveProofMetadata, MediaProof
└── redis-data/               # Redisの永続化データ（.gitignore）
```

---

## 🚀 開発ロードマップ

### フェーズ1: コア機能完成

| タスク | 状態 | 優先度 |
| --- | --- | --- |
| Docker環境構築 | ✅ 完了 | - |
| Redis + BullMQ | ✅ 完了 | - |
| cNFTアドレス予測 | ✅ 完了 | - |
| Arweaveアップロード（Irys） | ✅ 完了 | - |
| cNFT mint | ✅ 完了 | - |
| 相互リンク検証（簡易版） | ✅ 完了 | - |
| R2二重バケット構成 | ✅ 完了 | - |
| Privy認証 | ✅ 完了 | - |
| アップロードフロー | ✅ 完了 | - |
| 証明書ページ（基本表示） | ✅ 完了 | - |
| **SolanaPay購入フロー** | ⏳ 未実装 | 🔴 最高 |
| **完全な相互リンク検証** | ⏳ 未実装 | 🔴 高 |
| **Lens機能（CLIP検索）** | ⏳ 未実装 | 🔴 最高 |

### フェーズ2: 安定化・最適化

| タスク | 優先度 |
| --- | --- |
| エラーハンドリング強化 | 🟡 中 |
| ジョブ状態可視化（管理ダッシュボード） | 🟡 中 |
| モニタリング（Worker healthcheck、アラート） | 🟡 中 |
| UIポリッシュ（処理中表示、状態表示等） | 🟡 中 |
| E2Eテスト | 🟡 中 |

### フェーズ3: スケーリング

| タスク | 優先度 |
| --- | --- |
| マルチツリー対応（Tree振り分けロジック） | 🟢 低 |
| Worker並列化（Tree別Worker起動） | 🟢 低 |
| 負荷分散 | 🟢 低 |

---

## 📚 参考資料

- [C2PA Technical Specification](https://c2pa.org/specifications/)
- [c2pa-rs GitHub](https://github.com/contentauth/c2pa-rs)
- [Metaplex Bubblegum](https://developers.metaplex.com/bubblegum)
- [Metaplex Umi](https://developers.metaplex.com/umi)
- [Helius DAS API](https://docs.helius.dev/compression-and-das-api/digital-asset-standard-das-api)
- [SolanaPay Specification](https://docs.solanapay.com/)
- [Privy Documentation](https://docs.privy.io/)
- [Cloudflare R2 Documentation](https://developers.cloudflare.com/r2/)
- [Irys Documentation](https://docs.irys.xyz/)
- [BullMQ Documentation](https://docs.bullmq.io/)
- [Supabase pgvector](https://supabase.com/docs/guides/ai/vector-columns)
- [OpenAI CLIP](https://github.com/openai/CLIP)
