RootLens 企画・仕様書（Ver.5）✅ MVP完成版

## 📋 概要

**RootLens**は、C2PAハードウェア署名とブロックチェーン技術を組み合わせ、AI時代における「現実」の価値を再定義し、保護するプラットフォームです。

### 技術の役割分担

RootLensは2つの技術を組み合わせていますが、それぞれの役割は明確に異なります。

| 技術 | 担当する役割 |
| --- | --- |
| **C2PA** | コンテンツの真正性証明、改ざん検出、来歴情報の保持 |
| **Blockchain** | 所有権の帰属先の明確化、権利の流動化（売買・譲渡）、乗っ取り防止 |

> 重要: C2PAだけでもトラストレスな真正性検証は可能です。ブロックチェーンは「誰のものか」と「権利の流動性」を担います。
> 

### 解決する課題

| 課題 | 解決技術 | RootLensの解決策 |
| --- | --- | --- |
| **AI生成コンテンツの氾濫** | C2PA | ハードウェア署名を検証し、実在性を暗号技術で担保 |
| **コンテンツの改ざん** | C2PA | 改ざんがあれば検出される（元データがあれば誰でも検証可能） |
| **所有権の不明確さ** | Blockchain | ウォレットに紐づけ、権利の帰属先を明確化 |
| **権利の乗っ取り** | Blockchain | Arweave ⇄ cNFT の相互リンク設計により乗っ取りを防止 |
| **権利の固定化** | Blockchain | NFTとして売買・譲渡が可能 |
| **収益化手段の欠如** | Blockchain | Solana Payによる直接取引で撮影者に対価を還元 |

### コアコンセプト

**「Root（始祖）がハードウェア署名であれば、編集済みデータも受け入れる」**

- 無加工のみを対象とせず、色調整・トリミング等を行った報道写真やアート作品も対象
- 重要なのは「どんなに加工されていても、その根っこ（Root）がハードウェア署名である」こと

### ターゲットユーザー

| ユーザー層 | ニーズ |
| --- | --- |
| フォトグラファー・ジャーナリスト | 撮影データの真正性証明、収益化 |
| 報道機関 | 情報源の信頼性担保、証明付きメディアの購入 |
| SNSインフルエンサー | 事実を扱うコンテンツの信頼性向上 |
| AI企業 | クリーンな学習データの調達・購入 |

---

## 🏗️ システムアーキテクチャ

### 全体構成

```
┌─────────────────────────────────────────────────────────────────┐
│                        クライアント                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ アップロード     │  │ 証明書ページ     │  │ 購入            │ │
│  │ ・C2PA検証(WASM)│  │ ・Arweave読取り  │  │ ・SolanaPay     │ │
│  │ ・ハッシュ計算   │  │ ・cNFT検証       │  │ ・即時DL        │ │
│  └────────┬────────┘  │ ・相互リンク検証 │  │                 │ │
│           │           │ ・メディア表示   │  │                 │ │
│           │           └────────┬────────┘  └────────┬────────┘ │
└───────────┼───────────────────┼───────────────────┼────────────┘
            │                   │                   │
            ▼                   ▼                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Docker Compose 環境                           │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   Next.js (Frontend)                      │  │
│  │  ・API Routes（ジョブ投入、ステータス確認）                │  │
│  │  ・Presigned URL発行（Private R2）                        │  │
│  │  ・Public Bucket直接アップロード（Manifest・サムネイル）    │  │
│  │  ・購入処理（DB記録、DLリンク発行）                        │  │
│  └──────────────────────┬───────────────────────────────────┘  │
│                         │ Job追加                               │
│                         ▼                                       │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                      Redis                                │  │
│  │              (BullMQ ジョブキュー)                         │  │
│  └──────────────────────┬───────────────────────────────────┘  │
│                         │ Job取得（直列）                       │
│                         ▼                                       │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   Worker (Node.js)                        │  │
│  │  ・次のcNFTアドレス予測（TreeConfig.numMinted参照）        │  │
│  │  ・Arweaveアップロード（Umi + Irys）                      │  │
│  │  ・cNFT mint（Arweave URI設定）                           │  │
│  │  ・concurrency: 1 で完全直列処理                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│      ┌───────────────┬───────────────┬───────────────┐          │
│      ▼               ▼               ▼               ▼          │
│  ┌────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │
│  │   R2   │  │  Arweave    │  │   Solana    │  │  Supabase  │  │
│  │2バケット│  │ (via Irys)  │  │   cNFT     │  │  DB+Cache  │  │
│  │Private │  │ 証明参照     │  │ (BubbleGum)│  │  +pgvector │  │
│  │+ Public│  │ データ       │  │            │  │            │  │
│  └────────┘  └─────────────┘  └─────────────┘  └────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              Cloudflare Workers AI (Lens)                 │  │
│  │  ・uform-gen2-qwen-500m（画像キャプション生成）            │  │
│  │  ・bge-base-en-v1.5（テキスト埋め込み）                    │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘

```

### 技術スタック

| レイヤー | 技術 | 選定理由 |
| --- | --- | --- |
| Frontend | Next.js 15 (App Router) | React Server Components、API Routes統合 |
| Blockchain | Solana (BubbleGum/Metaplex) | cNFTによる低コスト大量mint |
| 永久保存 | Arweave (via Irys) | 永久保存、Umi統合、SOL払い |
| Storage | Cloudflare R2 (2バケット) | Egress無料、Private+Public構成 |
| Database | Supabase (PostgreSQL + pgvector) | DB + ベクトル検索 |
| C2PA | c2pa-rs (WASM) | ブラウザ上でのC2PA検証 |
| Auth | Privy | ウォレット + SMS認証 |
| 決済 | SolanaPay | 直接送金、手数料最小化 |
| RPC | Helius | cNFT読み取り、DAS API |
| ジョブキュー | BullMQ + Redis | 直列処理、リトライ、スケーラブル |
| Lens検索 | Cloudflare Workers AI | uform-gen2-qwen-500m + bge-base-en-v1.5 |
| コンテナ | Docker Compose | 開発・本番環境の統一 |

### トラストモデル

```
┌─────────────────────────────────────────────────────────────────┐
│                    信頼の構造                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  【C2PAが担保するもの（元データがあれば誰でも検証可能）】          │
│  ├─ コンテンツがハードウェアで撮影されたこと                     │
│  ├─ 撮影後の編集履歴（来歴情報）                                │
│  └─ 改ざんの有無（改ざんされていれば検出される）                 │
│                                                                 │
│  【ブロックチェーンが担保するもの】                               │
│  ├─ 所有権の帰属先（ウォレットアドレス）                         │
│  ├─ 権利の流通履歴（NFTの譲渡履歴）                             │
│  └─ 乗っ取り防止（相互リンクによる真正性）                       │
│                                                                 │
│  【信頼する必要があるもの】                                       │
│  ├─ C2PA仕様（暗号技術）                                         │
│  ├─ ハードウェアメーカーのRoot CA（Sony, Google等）               │
│  ├─ Solanaブロックチェーン                                       │
│  └─ Arweaveネットワーク                                          │
│                                                                 │
│  【RootLensサーバーの役割】                                       │
│  ├─ 証明書ページでの表示（manifest.jsonの内容表示）              │
│  │   → ただし元ファイル自体はC2PA署名により改ざん検出可能        │
│  │                                                               │
│  ├─ Arweaveアップロード時のウォレット署名                         │
│  │   → 「正規のRootLensから発行された」ことの証明                 │
│  │   → Irys Explorerでウォレットアドレスを確認可能               │
│  │                                                               │
│  └─ 次のcNFTアドレス予測                                         │
│     → TreeConfig.numMintedを読み取り、leaf indexを決定           │
│     → PDA計算は誰でも検証可能                                    │
│     → 直列処理により競合を完全に防止                             │
│                                                                 │
│  【購入後の検証】                                                 │
│  ├─ 元ファイルにC2PA署名が埋め込まれている                       │
│  ├─ ファイルをダウンロードしてc2pa-rsで検証可能                 │
│  ├─ Root署名者、証明書チェーン、ハッシュ値をすべて検証可能        │
│  └─ 真正性の検証はC2PAにより保証される                           │
│                                                                 │
│  【「楽観的な証明」としての証明書ページ】                         │
│  ├─ C2PAの弱点: 元データが手元にないと来歴証明ができない          │
│  ├─ RootLensの緩和策: 証明書ページの存在自体が                   │
│  │   「この画像はハードウェア由来である」という信頼の根拠となる   │
│  └─ 元データなしでも、証明書ページを見せることで信頼性を示せる    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

```

### データの役割分担

| データ種別 | 保存先 | 理由 |
| --- | --- | --- |
| 証明参照データ（ハッシュ、署名者等） | Arweave (via Irys) | 永久保存、所有権紐づけ用 |
| サムネイル画像 | R2 Public Bucket | 公開URL、削除可能 |
| C2PAメタデータ（manifest.json） | R2 Public Bucket | 公開URL、証明書ページで使用 |
| 元メディアファイル | R2 Private Bucket | Presigned URLのみ、販売対象 |
| 所有権（cNFT） | Solana | 譲渡可能、検証可能 |
| ビジネスデータ | Supabase | 可変、サービス固有 |
| 特徴量ベクトル | Supabase (pgvector) | Lens検索用 |
| ジョブキュー | Redis | 直列処理、リトライ管理 |

---

## 📁 データモデル

### Arweave構造（証明参照データの永久保存）

**Arweaveに保存するJSONメタデータ：**

```json
{
  "name": "RootLens Proof #abc123ef",
  "symbol": "RLENS",
  "description": "Media authenticity proof verified by RootLens",
  "image": "https://pub-xxxxx.r2.dev/media/abc123.../thumbnail.jpg",
  "target_asset_id": "7xKp...3mNv",
  "attributes": [
    { "trait_type": "original_hash", "value": "abc123ef..." },
    { "trait_type": "root_signer", "value": "Sony Corporation" },
    { "trait_type": "root_cert_chain", "value": "Base64エンコードされた証明書チェーン" },
    { "trait_type": "created_at", "value": "2025-01-15T12:00:00Z" }
  ]
}

```

**フィールド詳細：**

| フィールド | 内容 | サイズ | 用途 |
| --- | --- | --- | --- |
| `name` | 証明書の名前 | 50 bytes | 識別用 |
| `symbol` | シンボル（RLENS） | 10 bytes | 識別用 |
| `description` | 説明文 | 100 bytes | 説明 |
| `image` | サムネイル公開URL | 100 bytes | R2 Public Bucketへのリンク |
| `target_asset_id` | cNFTアドレス | 44 bytes | 相互リンク検証 |
| `original_hash` | 元ファイルのSHA-256 | 64 bytes | ファイル識別 |
| `root_signer` | Root CA名 | 50-100 bytes | 署名者表示・検索 |
| `root_cert_chain` | 証明書チェーン（Base64） | 1-3 KB | 参照用（実際の検証は元ファイルで行う） |
| `created_at` | タイムスタンプ | 30 bytes | 発行日時 |

**特徴：**

- サムネイルはR2 Public URLとして保存（削除可能）
- 証明参照データは最小限（3-5KB）
- Irys Explorerでウォレットアドレスを確認可能
- 実際のC2PA検証は元ファイルで行う（Arweaveのデータは参照用）

### cNFT構造（Solana / BubbleGum）

```json
{
  "name": "RootLens Proof #abc123ef",
  "symbol": "RLENS",
  "uri": "https://gateway.irys.xyz/xyz..."
}

```

**cNFTには最小限の情報のみ。詳細はArweave URIを参照。**

### 相互リンクによる所有権の真正性定義

```
┌─────────────────────────────────────────────────────────────────┐
│              「正当な所有権証明」の定義                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  以下の条件をすべて満たすArweaveデータを「正当な所有権証明」とする：│
│                                                                 │
│  1. Irys Explorerで、トランザクションの発行者が                 │
│     RootLensの公開ウォレットアドレスと一致する                   │
│                                                                 │
│  2. 同一original_hashを持つArweaveデータの中で、               │
│     target_asset_idに記載されたcNFTが最も古い                   │
│                                                                 │
│  3. そのcNFTのURIがこのArweaveデータを指している                 │
│     （相互リンクの成立）                                        │
│                                                                 │
│  ※ コンテンツの真正性自体はC2PAで保証される                      │
│  ※ ブロックチェーンは「誰がこの証明付きコンテンツを所有するか」   │
│     を担保する                                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

```

**攻撃シナリオと防御：**

| 攻撃 | 防御 |
| --- | --- |
| 先にコピーArweaveデータを作成 | Irys Explorerで発行者ウォレットを確認 → RootLensでない |
| 先にコピーcNFTを作成 | Arweaveのtarget_asset_idと一致しないため無効 |
| 正規cNFTをBurnして乗っ取り | Arweaveのtarget_asset_idは永久記録。新規mintしても相互リンクが成立しない |
| 同時リクエストで競合 | BullMQ concurrency:1 で完全直列化。競合不可 |

### Burn検出機能 ✅ 完全実装

```
┌─────────────────────────────────────────────────────────────────┐
│  cNFT Burn（削除）の検出と表示                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Helius DAS API レスポンスで burnt フラグを確認                 │
│  ↓                                                              │
│  if (result.burnt === true) {                                  │
│    ├─ 最終所有者を取得: result.ownership.owner                 │
│    ├─ 現在の所有者を空にする                                    │
│    └─ isBurned フラグを立てる                                   │
│  }                                                              │
│                                                                 │
│  【UI表示】                                                      │
│  ├─ 所有者情報に「Burn済み（削除）」バッジ表示                   │
│  ├─ 最終所有者のウォレットアドレス表示                           │
│  ├─ 購入ボタンを非表示                                          │
│  └─ 警告メッセージ: 「このNFTは削除されています」                │
│                                                                 │
│  【意味】                                                        │
│  ├─ Arweave の証明データは永久に残る                            │
│  ├─ cNFT の所有権のみが消滅                                     │
│  └─ 来歴証明としての価値は保持される                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### R2ストレージ構造（2バケット構成）

### Private Bucket（元データ専用）

```
media/{original_hash}/
└── original.{ext}          # 元メディアファイル（C2PA署名埋め込み済み）

```

- **アクセス**: Presigned URLのみ（購入者のみ、期限付き）
- **用途**: 販売対象、購入後のC2PA検証用
- **削除可能**: はい（GDPR対応、違法コンテンツ削除）

### Public Bucket（公開データ）

```
media/{original_hash}/
├── thumbnail.jpg           # サムネイル画像（50-200KB）
└── manifest.json           # C2PAメタデータ（50-500KB）

```

- **アクセス**: 公開URL（誰でもアクセス可能）
- **用途**: 証明書ページでの表示
- **削除可能**: はい（プライバシー保護）

**manifest.json の内容：**

```json
{
  "activeManifest": {
    "claim_generator": "Sony ILCE-7M4 1.0",
    "signature_info": {
      "issuer": "Sony Corporation",
      "cert_chain": ["-----BEGIN CERTIFICATE-----...", ...],
      "time": "2024-12-01T15:30:00Z"
    },
    "assertions": [
      {
        "label": "stds.exif",
        "data": { "exif:Make": "Sony", "exif:Model": "ILCE-7M4", ... }
      },
      {
        "label": "stds.iptc",
        "data": { "Caption": "富士山の夕焼け", ... }
      }
    ]
  },
  "validationStatus": { "isValid": true, "errors": [] },
  "thumbnailUrl": "data:image/jpeg;base64,/9j/4AAQ..."
}

```

### Supabaseスキーマ

### media_proofs テーブル（ビジネスデータ）

```sql
CREATE TABLE media_proofs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Arweave連携
    arweave_tx_id TEXT NOT NULL UNIQUE,

    -- cNFT連携
    cnft_mint_address TEXT NOT NULL UNIQUE,
    owner_wallet TEXT NOT NULL,

    -- R2パス導出用
    original_hash TEXT NOT NULL UNIQUE,
    file_extension TEXT NOT NULL,

    -- RootLens独自データ
    price_lamports BIGINT DEFAULT 0,
    title TEXT,
    description TEXT,

    -- 状態管理
    is_deleted BOOLEAN DEFAULT FALSE,
    is_public BOOLEAN DEFAULT TRUE,

    -- タイムスタンプ
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

```

**設計思想**: 証明参照データはArweaveに保存。Supabaseはビジネスロジック専用（価格、タイトル、状態管理のみ）

### purchases テーブル

```sql
CREATE TABLE purchases (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    media_proof_id UUID NOT NULL REFERENCES media_proofs(id),
    buyer_wallet TEXT NOT NULL,
    solana_tx_signature TEXT NOT NULL,
    amount_lamports BIGINT NOT NULL,
    seller_wallet TEXT NOT NULL,
    download_token TEXT NOT NULL UNIQUE,
    download_expires_at TIMESTAMPTZ NOT NULL,
    download_count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

```

### users テーブル（Privy連携）

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    privy_user_id TEXT NOT NULL UNIQUE,
    wallet_address TEXT NOT NULL,
    phone TEXT,
    display_name TEXT,
    bio TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

```

### feature_vectors テーブル（Lens機能用）

```sql
CREATE TABLE feature_vectors (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    media_proof_id UUID NOT NULL REFERENCES media_proofs(id),
    embedding vector(768),
    model_name TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

```

---

## 🔄 ユーザーフロー

### アップロードフロー

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: Privy認証                                              │
│  ├─ ウォレット接続                                               │
│  └─ SMS認証（オプション）                                        │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: ファイル選択                                            │
│  ユーザーがC2PA付きメディアをドラッグ＆ドロップ                    │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 3: クライアントサイドC2PA検証（WASM）                       │
│  ├─ c2pa.read(file) でManifest Storeを解析                      │
│  ├─ Ingredientsを再帰的に遡り、Rootを特定                        │
│  ├─ Root署名証明書が信頼済みリスト（ハードウェアCA）に含まれるか確認│
│  ├─ root_signer（CA名）を抽出                                   │
│  ├─ 証明書チェーン（cert_chain）をBase64エンコード               │
│  ├─ サムネイルをData URIに変換                                  │
│  └─ 検証失敗 → エラー表示、アップロード不可                       │
│                                                                 │
│  ※ この検証はC2PA技術によるもの（改ざんがあれば検出される）       │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 4: プライバシー警告表示                                    │
│  ├─ C2PAメタデータに含まれる情報を一覧表示                        │
│  │   （GPS、シリアル番号、撮影日時等）                           │
│  ├─ 「これらの情報が公開されます」と警告                          │
│  └─ ユーザーが続行を選択                                         │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 5: 価格・情報設定                                          │
│  ├─ 価格を設定（0 = 無料ダウンロード）                           │
│  ├─ タイトル（オプション）                                       │
│  └─ 説明文（オプション）                                         │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 6: クライアントサイドでハッシュ計算                         │
│  └─ 元メディアファイルのSHA-256ハッシュ（= original_hash）        │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 7: 重複チェック（API経由）                                 │
│  ├─ original_hashがすでにSupabaseに存在するか確認               │
│  └─ 存在する場合 → エラー表示、アップロード不可                   │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 8: R2アップロード（2段階）                                 │
│                                                                 │
│  【8-1】Private Bucketへ元ファイルアップロード                   │
│  ├─ POST /api/upload/presigned でPresigned URL取得             │
│  ├─ original.{ext} をPUTでアップロード                          │
│  └─ パス: media/{hash}/original.{ext}                          │
│                                                                 │
│  【8-2】Public Bucketへmanifest・サムネイルアップロード           │
│  ├─ POST /api/upload/public を呼び出し                         │
│  ├─ サーバー側でthumbnail.jpg をアップロード                    │
│  ├─ サーバー側でmanifest.json をアップロード                    │
│  └─ 公開URLを取得                                               │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 9: Mintジョブを投入                                        │
│  ├─ POST /api/upload で以下のデータを送信:                      │
│  │   - userWallet                                              │
│  │   - originalHash                                            │
│  │   - rootSigner                                              │
│  │   - rootCertChain (Base64)                                  │
│  │   - mediaFilePath                                           │
│  │   - thumbnailPublicUrl                                      │
│  │   - price, title, description                               │
│  ├─ BullMQのキューにジョブを追加                                 │
│  └─ ユーザーに「処理中」と即座にレスポンス                        │
└─────────────────────────────────────────────────────────────────┘
                                ↓
        ┌─────────────────────────────────────────────────────────┐
        │  【Worker側で直列処理】                                  │
        │                                                         │
        │  Step 10: 既存チェック（冪等性担保）                     │
        │  └─ Supabaseでoriginal_hashを検索                       │
        │                                                         │
        │  Step 11: 次のcNFTアドレス予測                          │
        │  ├─ TreeConfig.numMintedを取得                          │
        │  ├─ 次のleaf indexを決定                                │
        │  └─ PDAを計算してAsset IDを予測                          │
        │                                                         │
        │  Step 12: Arweaveアップロード（Umi + Irys）              │
        │  ├─ 証明参照データJSONを作成:                            │
        │  │   - target_asset_id: 予測したcNFTアドレス            │
        │  │   - image: サムネイル公開URL（R2）                   │
        │  │   - attributes: ハッシュ、署名者、証明書チェーン等    │
        │  └─ umi.uploader.uploadJson()                           │
        │                                                         │
        │  Step 13: cNFT mint                                     │
        │  ├─ Metaplex BubbleGum SDKでcNFTをmint                  │
        │  ├─ uri: Arweave URI                                    │
        │  └─ 予測IDと実際のIDの一致を確認                         │
        │                                                         │
        │  Step 14: Supabaseに保存                                │
        │  └─ media_proofsテーブルに記録                          │
        └─────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 15: 完了通知                                               │
│  ├─ フロントエンドでジョブステータスをポーリング                  │
│  ├─ 証明書ページURLを表示                                        │
│  ├─ URLコピーボタン                                              │
│  └─ SNSシェアボタン                                              │
└─────────────────────────────────────────────────────────────────┘

```

### アセットページ（証明・購入・ダウンロード）

**URL形式**: `rootlens.io/asset/{original_hash}`

### 検証フロー（完全版・5ステップ検証）

```
┌─────────────────────────────────────────────────────────────────┐
│        所有権の正当性検証プロセス（リアルタイム）                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Step 1: 永久記録を探す                                         │
│  ├─ Arweave GraphQL API で original_hash をタグ検索            │
│  │   (searchArweaveTransactionsByHash)                        │
│  ├─ 複数の候補が見つかった場合は全て検証                         │
│  └─ RootLens公式ウォレットから発行されたものを優先               │
│                                                                 │
│  Step 2: デジタル所有権を確認                                   │
│  ├─ Helius DAS API で cNFT の存在確認                          │
│  │   (checkSolanaAssetExists)                                 │
│  ├─ 所有者ウォレットアドレス取得                                │
│  ├─ Burn判定（burnt === true の場合）                         │
│  │   └─ 最終所有者を表示、現在は「削除済み」と表示              │
│  └─ 失敗時は DB フォールバック                                  │
│                                                                 │
│  Step 3: 来歴データを取得                                       │
│  ├─ Irys Gateway から Arweave メタデータ取得                   │
│  │   (fetchArweaveMetadata)                                   │
│  ├─ attributes から root_signer 抽出                           │
│  ├─ target_asset_id（相互リンク先）を取得                      │
│  └─ C2PA manifest.json を R2 Public Bucket から取得           │
│                                                                 │
│  Step 4: 乗っ取り防止チェック（相互リンク検証）                   │
│  ├─ arweaveToCnft: Arweave の target_asset_id が                │
│  │   実際の cNFT mint address と一致するか                     │
│  ├─ cnftToArweave: cNFT の URI に Arweave txId が               │
│  │   含まれているか（相互参照の成立）                            │
│  └─ 両者が互いに指し合っている = 正当な所有権証明                │
│                                                                 │
│  Step 5: コピー発行の確認（重複チェック）                        │
│  ├─ Supabase で original_hash を検索                           │
│  ├─ 複数レコードがある場合、現在の cNFT が最古か確認            │
│  │   └─ created_at でソートし、最初のものが「真の証明」         │
│  └─ RootLens 公式ウォレット発行のみを信頼                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  アセットページ表示                                              │
│  ├─ 検証結果バッジ（✅ RootLens Verified / ❌ Invalid）         │
│  ├─ サムネイル表示（C2PA thumbnail または R2 Public URL）       │
│  ├─ 所有者情報（ウォレットアドレス + Burn状態）                  │
│  ├─ C2PA 詳細情報（Provenance Timeline）                        │
│  ├─ デジタル資産証明（4カラム: C2PA, AI判定, Arweave, cNFT）    │
│  ├─ 技術仕様（Technical Details）                               │
│  └─ 購入ボタン（価格表示 + SolanaPay統合）                      │
└─────────────────────────────────────────────────────────────────┘

```

### 購入フロー（SolanaPay）

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: 証明書ページで「購入」ボタンをクリック                  │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: Privy認証確認                                           │
│  ├─ 未ログイン → ログインプロンプト表示                          │
│  └─ ログイン済み → 次へ                                          │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 3: SolanaPay決済                                           │
│  ├─ 所有者ウォレットへ送金トランザクション作成                   │
│  ├─ ウォレットで署名                                             │
│  └─ トランザクション送信                                         │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 4: サーバー側で購入記録                                    │
│  ├─ トランザクション署名を検証                                   │
│  ├─ purchasesテーブルに記録                                      │
│  │   - buyer_wallet                                             │
│  │   - solana_tx_signature                                      │
│  │   - download_token（UUID生成）                               │
│  │   - download_expires_at（24時間後）                          │
│  └─ ダウンロードトークンをレスポンス                             │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 5: 即時ダウンロード                                        │
│  ├─ GET /download/{download_token}                              │
│  ├─ トークン検証（有効期限、使用回数）                           │
│  ├─ Presigned URL生成（Private Bucket）                         │
│  │   - media/{hash}/original.{ext}                             │
│  │   - 有効期限: 1時間                                          │
│  └─ リダイレクトでダウンロード開始                               │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 6: 購入後のC2PA検証（ユーザー側）                          │
│  ├─ c2pa.read(file) でC2PA検証                                  │
│  ├─ Root署名者を確認                                             │
│  ├─ 証明書チェーンを確認                                         │
│  └─ コンテンツの真正性はC2PAにより保証される                     │
└─────────────────────────────────────────────────────────────────┘

```

---

## 📊 Dashboard機能 ✅ 完全実装済み

### 概要

ユーザーが所有するアセットと購入済みコンテンツを一元管理するダッシュボード機能。

**URL**: `/dashboard`

### 実装機能

#### 1. 所有権同期（Helius DAS API統合）✅

```
┌─────────────────────────────────────────────────────────────────┐
│  リアルタイム所有権同期                                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  GET /api/creator-content?walletAddress={address}              │
│  ↓                                                              │
│  1. Helius DAS API で getAssetsByOwner を呼び出し               │
│     └─ ウォレットが実際に所有している全cNFTを取得               │
│                                                                 │
│  2. 所有cNFTのミントアドレスリストを抽出                         │
│                                                                 │
│  3. Supabase で IN クエリ実行                                   │
│     └─ cnft_mint_address IN (ownedCnftMintAddresses)          │
│                                                                 │
│  4. owner_wallet が古い場合、一括更新                           │
│     └─ バッチ UPDATE で最新の所有者に同期                       │
│                                                                 │
│  ✅ NFT譲渡後も正しい所有者が反映される                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 2. ページネーション✅

```
【実装詳細】
├─ itemsPerPage: 20件
├─ ページ切り替え時に API 再フェッチ
├─ クエリパラメータ: page, limit
├─ レスポンス: items[], total, page, totalPages
└─ UI: 前後ボタン + ページ番号表示（最大7つ）

【状態管理】
├─ 所有アセットタブ: ownedPage, ownedTotal, ownedTotalPages
├─ 購入済みタブ: purchasedPage, purchasedTotal, purchasedTotalPages
└─ useEffect でページ変更時に自動再取得
```

#### 3. アセット編集機能（EditAssetModal）✅

```
POST /api/creator-content/update

【編集可能項目】
├─ タイトル（title）
├─ 説明文（description）
└─ 価格（price）
   ├─ フロント入力: SOL単位
   ├─ API送信: Lamports（× 10^9）
   └─ 0 = 無料ダウンロード

【権限チェック】
└─ walletAddress === owner_wallet のみ編集可能

【UI】
├─ 各アセットカードに編集ボタン（PenTool icon）
├─ モーダル表示
├─ 保存成功時にリスト自動更新
└─ エラーハンドリング
```

#### 4. 公開/非公開切り替え✅

```
POST /api/creator-content/toggle-public

【機能】
├─ is_public フラグを反転
├─ 公開: 誰でもアセットページにアクセス可能
├─ 非公開: 所有者・購入者のみアクセス可能
└─ C2PA manifest.json も非公開時は所有者のみ表示

【UI】
├─ 公開中: 緑バッジ「公開中」（Eye icon）
├─ 非公開: グレーバッジ「非公開」（EyeOff icon）
└─ ボタンクリックで即座に切り替え
```

### Dashboard UI 詳細

```
┌─────────────────────────────────────────────────────────────────┐
│  ヘッダー                                                         │
│  ├─ タイトル: 「ダッシュボード」                                 │
│  ├─ サブタイトル: 「あなたのデジタル資産と購入履歴を管理します」  │
│  └─ 「新規アセット作成」ボタン → /upload                         │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  タブ切り替え                                                     │
│  ├─ 所有アセット（creatorContents.length件）                     │
│  └─ 購入済み（purchasedContents.length件）                      │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  所有アセット タブ                                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  【グリッド表示】                                                 │
│  ├─ 2列（MD） / 3列（LG） / 4列（XL） / 5列（2XL）               │
│  └─ 各カード:                                                     │
│     ├─ サムネイル画像（aspect-square）                           │
│     ├─ 公開/非公開バッジ（右上）                                 │
│     ├─ タイトル                                                  │
│     ├─ cNFT address（短縮表示）                                 │
│     ├─ 価格表示                                                  │
│     ├─ 編集ボタン                                                │
│     ├─ 詳細ボタン → /asset/[hash]                               │
│     └─ 公開/非公開切り替えボタン                                 │
│                                                                 │
│  【Empty State】                                                 │
│  └─ 「まだアセットがありません」+ 作成を始めるボタン               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  購入済み タブ                                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  【グリッド表示】                                                 │
│  ├─ 同じグリッドレイアウト                                        │
│  └─ 各カード:                                                     │
│     ├─ サムネイル画像                                            │
│     ├─ タイトル                                                  │
│     ├─ 購入日時                                                  │
│     ├─ ダウンロードボタン                                        │
│     │  └─ /api/download/[token] へリダイレクト                  │
│     └─ 「資産ページを確認」ボタン → /asset/[hash]               │
│                                                                 │
│  【Empty State】                                                 │
│  └─ 「購入履歴がありません」+ コンテンツを探すボタン               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  ページネーション                                                 │
│  ├─ 前へ / 次へボタン                                            │
│  ├─ ページ番号（最大7つ表示）                                    │
│  └─ 現在ページ / 総ページ数表示                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔍 Lens機能（画像検索）✅ 完全実装済み

### 概要

Cloudflare Workers AIを使用して、アップロードされた画像の特徴量ベクトルを抽出し、意味検索・画像検索を実現します。

**実装状況**: Cloudflare Workers にデプロイ済み、フロントエンド統合済み

### 技術構成

| 項目 | 技術 | 用途 |
| --- | --- | --- |
| 画像→テキスト | uform-gen2-qwen-500m | 画像からキャプション（説明文）を生成 |
| テキスト→ベクトル | bge-base-en-v1.5 | キャプションを768次元ベクトルに変換 |
| ベクトルDB | Supabase pgvector | コサイン類似度検索 |
| 実行環境 | Cloudflare Workers AI | エッジでの高速推論 |

### 検索インターフェース（/lens ページ）

```
┌─────────────────────────────────────────────────────────────────┐
│  3つの検索方法                                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1️⃣ テキスト検索                                                 │
│  ├─ 検索クエリ入力（例: "sunset over mountain"）                │
│  ├─ Workers AI で埋め込みベクトル生成                           │
│  └─ pgvector でコサイン類似度検索                                │
│                                                                 │
│  2️⃣ 画像検索（ドラッグ＆ドロップ対応）                            │
│  ├─ 画像ファイルをアップロード                                   │
│  ├─ 自動リサイズ（MAX_SIZE: 800px、JPEG品質: 0.85）             │
│  ├─ Workers AI でキャプション生成 → 埋め込み                    │
│  └─ 類似画像検索                                                 │
│                                                                 │
│  3️⃣ カメラ検索（Google Lens風）                                  │
│  ├─ getUserMedia で外カメラ起動                                 │
│  ├─ Canvas で撮影                                               │
│  └─ 撮影画像で自動的に画像検索実行                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### UI機能

```
【検索結果表示】
├─ レスポンシブグリッド（2列MD / 3列LG / 4列XL）
├─ 各結果カードに:
│  ├─ サムネイル画像（R2 Public Bucket）
│  ├─ 類似度スコア（0-100%）
│  ├─ タイトル
│  ├─ 価格（Free / X.XX SOL）
│  ├─ 作成日時
│  └─ クリックで /asset/[hash] へ遷移
├─ ローディング状態表示
├─ エラーハンドリング
└─ 全画面ドラッグオーバーレイ（画像検索用）
```

### アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│  アップロード時                                                  │
│                                                                 │
│  サムネイル画像                                                   │
│       ↓                                                         │
│  Cloudflare Workers AI                                          │
│  ├─ uform-gen2-qwen-500m → キャプション生成                     │
│  └─ bge-base-en-v1.5 → 768次元ベクトル                          │
│       ↓                                                         │
│  Supabase (pgvector)                                            │
│  feature_vectors テーブル                                        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  テキスト検索時                                                  │
│                                                                 │
│  検索クエリ（テキスト）                                          │
│       ↓                                                         │
│  Cloudflare Workers AI                                          │
│  └─ bge-base-en-v1.5 → クエリベクトル                           │
│       ↓                                                         │
│  pgvector コサイン類似度検索                                     │
│       ↓                                                         │
│  類似画像トップN件                                               │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  画像検索時                                                      │
│                                                                 │
│  検索クエリ（画像）                                              │
│       ↓                                                         │
│  Cloudflare Workers AI                                          │
│  ├─ uform-gen2-qwen-500m → キャプション生成                     │
│  └─ bge-base-en-v1.5 → クエリベクトル                           │
│       ↓                                                         │
│  pgvector コサイン類似度検索                                     │
│       ↓                                                         │
│  類似画像トップN件                                               │
└─────────────────────────────────────────────────────────────────┘

```

### 処理フロー

### 特徴量抽出（アップロード時）

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: アップロード完了後                                      │
│  └─ lens-workerにサムネイル画像を送信                            │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: キャプション生成                                        │
│  ├─ uform-gen2-qwen-500mでサムネイルを解析                      │
│  └─ 画像の内容を説明するテキストを生成                           │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 3: ベクトル化                                              │
│  ├─ bge-base-en-v1.5でキャプションを埋め込み                    │
│  └─ 768次元ベクトルを生成                                        │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 4: Supabaseに保存                                          │
│  └─ feature_vectors テーブルに挿入                               │
│     - media_proof_id: 対象のProof ID                            │
│     - embedding: 特徴量ベクトル（pgvector型）                    │
│     - model_name: "bge-base-en-v1.5"                            │
└─────────────────────────────────────────────────────────────────┘

```

### 類似画像検索

```sql
SELECT media_proof_id,
       1 - (embedding <=> query_vector) AS similarity
FROM feature_vectors
ORDER BY embedding <=> query_vector
LIMIT 20;

```

### 副次的効果：信頼性検索

Lens機能には、単なる画像検索以上の価値があります：

> 「この画像は、証明付きの"本物"として登録されているか？」
> 

を検索できる**信頼性の検証ツール**として機能します。

- ユーザーが増え、登録画像が増えるほど、検証ツールとしての価値が高まる
- 「ヒットしない＝偽物」とは限らないが、「ヒットする＝証明付き」は確実

---

## 🔧 cNFTアドレス予測ロジック

### 技術的背景

cNFTのAsset IDは、Merkle TreeのアドレスとLeaf Indexから導出されるPDA（Program Derived Address）です。

```tsx
// PDA導出の仕組み
const [assetId, bump] = await PublicKey.findProgramAddress(
  [
    Buffer.from("asset"),
    merkleTree.toBuffer(),
    leafIndex.toArrayLike(Buffer, 'le', 8),
  ],
  MPL_BUBBLEGUM_PROGRAM_ID
);

```

### 予測のためのステップ

```tsx
import { fetchTreeConfigFromSeeds, findLeafAssetIdPda } from '@metaplex-foundation/mpl-bubblegum';

async function predictNextAssetId(umi: Umi, merkleTree: PublicKey) {
  // 1. TreeConfigからnum_mintedを取得
  const treeConfig = await fetchTreeConfigFromSeeds(umi, { merkleTree });

  // 2. 次のleaf indexはnum_minted（0-indexed）
  const nextLeafIndex = treeConfig.numMinted;

  // 3. Asset IDを事前計算
  const [predictedAssetId] = await findLeafAssetIdPda(umi, {
    merkleTree,
    leafIndex: nextLeafIndex
  });

  return {
    predictedAssetId: predictedAssetId.toString(),
    nextLeafIndex: nextLeafIndex
  };
}

```

### 直列処理による競合防止

**なぜ直列処理が必要か：**

```
┌─────────────────────────────────────────────────────────────────┐
│  並列処理の場合（危険）                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  User A ─┬─ numMinted=100を読む ─┬─ ID予測=Asset#100           │
│          │                       │                              │
│  User B ─┴─ numMinted=100を読む ─┴─ ID予測=Asset#100 ← 重複！  │
│                                                                 │
│  → 両方がAsset#100を予測してArweaveにアップロード               │
│  → 一方のmintが失敗、または相互リンクが壊れる                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  直列処理の場合（安全）                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  User A ─── numMinted=100 ─── ID予測=Asset#100 ─── mint完了    │
│                                              │                  │
│  User B ─── (待機中) ─────────────────────────┘                 │
│         └── numMinted=101 ─── ID予測=Asset#101 ─── mint完了    │
│                                                                 │
│  → 完全に順番通り。競合なし。                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

```

---

## 🛡️ セキュリティ

### アクセス制御

| リソース | アクセス |
| --- | --- |
| 証明書ページ | パブリック（誰でも閲覧可） |
| Arweaveデータ | パブリック（誰でも読める） |
| cNFTデータ | パブリック（ブロックチェーン） |
| R2 Public Bucket（manifest、サムネイル） | パブリック（公開URL） |
| R2 Private Bucket（元ファイル） | プライベート（Presigned URLのみ） |
| Redisキュー | プライベート（Docker内部ネットワーク） |

### サーバー公開鍵の管理

```
┌─────────────────────────────────────────────────────────────────┐
│  RootLensサーバーウォレット管理                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  【公開鍵】                                                      │
│  ├─ Irys Explorerでトランザクション発行者として記録される        │
│  └─ 公開情報として誰でも検証可能                                │
│                                                                 │
│  【秘密鍵】                                                      │
│  ├─ Workerコンテナのみが保持                                    │
│  ├─ 環境変数経由で注入（JSON配列形式）                          │
│  ├─ 本番環境ではHSM等での保護を推奨                             │
│  └─ 鍵のローテーション計画を策定                                │
│                                                                 │
│  【鍵漏洩時の対応】                                              │
│  ├─ 新しい鍵ペアを生成                                          │
│  ├─ 旧公開鍵を「失効」リストに追加                              │
│  └─ 検証ロジックで失効リストを参照                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

```

### 違法コンテンツ対応

```
┌─────────────────────────────────────────────────────────────────┐
│  違法コンテンツが報告された場合                                  │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: R2からファイルを削除                                    │
│  ├─ Private Bucket: original.{ext}                              │
│  ├─ Public Bucket: thumbnail.jpg, manifest.json                 │
│  └─ → ダウンロード不可、証明書ページでサムネイル非表示           │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: DBのis_deletedフラグを立てる                            │
│  └─ 証明書ページで「削除済み」と表示                              │
└─────────────────────────────────────────────────────────────────┘

【Arweave/cNFTについて】
- 削除できない（技術的制約）
- ただし、Arweaveには違法コンテンツ自体は含まれない（メタデータのみ）
- cNFTも同様（URIのみ）
- むしろ、アップロードした人物の特定に使用可能（証拠として残る）

```

---

## ⚙️ 環境変数

```bash
# ===== Privy (認証) =====
NEXT_PUBLIC_PRIVY_APP_ID=

# ===== Supabase (データベース) =====
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# ===== Cloudflare R2 (ストレージ) =====
R2_ACCOUNT_ID=
R2_ACCESS_KEY_ID=
R2_SECRET_ACCESS_KEY=
R2_BUCKET_NAME=rootlens-media              # Private bucket
R2_PUBLIC_BUCKET_NAME=rootlens-public      # Public bucket
R2_PUBLIC_BUCKET_URL=https://pub-xxxxx.r2.dev
NEXT_PUBLIC_R2_PUBLIC_BUCKET_URL=https://pub-xxxxx.r2.dev

# ===== Cloudflare Workers AI (Lens) =====
CLOUDFLARE_ACCOUNT_ID=
CLOUDFLARE_API_TOKEN=

# ===== Redis (Docker内部) =====
REDIS_HOST=redis
REDIS_PORT=6379

# ===== Solana =====
SOLANA_RPC_URL=https://api.devnet.solana.com
SOLANA_PRIVATE_KEY=                        # JSON配列形式: [1,2,3,...]

# ===== Metaplex (Merkle Tree) =====
MERKLE_TREE_ADDRESS=

# ===== Helius (DAS API) =====
HELIUS_API_KEY=

# ===== Irys (Arweaveアップロード) =====
IRYS_ADDRESS=https://devnet.irys.xyz       # devnet
# IRYS_ADDRESS=https://node1.irys.xyz      # mainnet

# ===== ビューワー =====
NEXT_PUBLIC_ARWEAVE_GATEWAY=https://gateway.irys.xyz
NEXT_PUBLIC_ARWEAVE_EXPLORER_URL=https://devnet.irys.xyz/tx
NEXT_PUBLIC_SOLANA_EXPLORER_URL=https://orb.helius.dev/address

# ===== App URL =====
NEXT_PUBLIC_APP_URL=http://localhost:3000

```

---

## 📦 使用SDK・ライブラリ

| 用途 | ライブラリ |
| --- | --- |
| フロントエンド | Next.js 15 (App Router) |
| 認証 | @privy-io/react-auth |
| C2PA | c2pa-rs (WASM) |
| Solana | @solana/web3.js |
| cNFT | @metaplex-foundation/mpl-bubblegum |
| Umi | @metaplex-foundation/umi |
| Arweave | @metaplex-foundation/umi-uploader-irys |
| SolanaPay | @solana/pay |
| DB | @supabase/supabase-js |
| ジョブキュー | bullmq, ioredis |
| Lens | Cloudflare Workers AI |
| UI | Radix UI, Tailwind CSS |

---

## 🗂️ ディレクトリ構成

```
root/
├── docker-compose.yml        # 全体の起動管理
├── .env.example              # 環境変数テンプレート
├── supabase-schema.sql       # Supabaseスキーマ
├── SPECS.md                  # 本仕様書
├── frontend/                 # Next.js (Producer: ジョブを追加する側)
│   ├── app/
│   │   ├── api/
│   │   │   ├── upload/
│   │   │   │   ├── route.ts              # ジョブ投入API
│   │   │   │   ├── presigned/route.ts    # Presigned URL発行
│   │   │   │   └── public/route.ts       # Public Bucket直接アップロード
│   │   │   ├── creator-content/
│   │   │   │   ├── route.ts              # 所有アセット一覧取得
│   │   │   │   ├── toggle-public/route.ts  # 公開/非公開切り替え
│   │   │   │   └── update/route.ts       # アセット情報編集
│   │   │   ├── purchased-content/route.ts  # 購入済みコンテンツ一覧
│   │   │   ├── job-status/[jobId]/route.ts  # ジョブステータス確認
│   │   │   ├── download/[token]/route.ts    # 購入後ダウンロード
│   │   │   ├── purchase/
│   │   │   │   ├── route.ts              # 購入確認・記録
│   │   │   │   └── check/route.ts        # 購入状態確認
│   │   │   ├── lens/search/route.ts      # Lens検索API
│   │   │   └── sync-owner/route.ts       # 所有権同期
│   │   ├── asset/[originalHash]/page.tsx # アセット詳細ページ（検証・購入）
│   │   ├── upload/page.tsx               # アップロードページ
│   │   ├── lens/page.tsx                 # Lens検索ページ
│   │   ├── dashboard/page.tsx            # ダッシュボード
│   │   ├── download/[token]/page.tsx     # ダウンロードページ
│   │   ├── lib/
│   │   │   ├── r2.ts                     # R2操作（2バケット対応）
│   │   │   ├── queue.ts                  # BullMQ Queue設定
│   │   │   ├── supabase.ts               # Supabaseクライアント
│   │   │   ├── c2pa-parser.ts            # C2PA解析ヘルパー
│   │   │   ├── irys-verification.ts      # Arweave検証
│   │   │   └── verification-helpers.ts   # 検証ヘルパー関数
│   │   └── components/
│   │       ├── Header.tsx                # ナビゲーション
│   │       ├── LoadingState.tsx          # ローディング表示
│   │       ├── ProgressBar.tsx           # 進捗バー
│   │       ├── StepContainer.tsx         # ステップUI
│   │       ├── PrivacyWarning.tsx        # プライバシー警告
│   │       ├── ProvenanceModal.tsx       # 来歴詳細モーダル
│   │       ├── ProvenanceTimeline.tsx    # タイムライン表示
│   │       ├── TechnicalSpecsModal.tsx   # 技術仕様モーダル
│   │       ├── TechnicalDetailsSection.tsx  # 技術詳細セクション
│   │       ├── PurchaseModal.tsx         # 購入モーダル
│   │       ├── EditAssetModal.tsx        # アセット編集モーダル
│   │       └── AssetThumbnail.tsx        # サムネイル表示
│   ├── package.json
│   └── Dockerfile
├── worker/                   # Node.js (Consumer: ジョブを処理する側)
│   ├── src/
│   │   ├── worker.ts         # BullMQ Worker設定
│   │   ├── processor.ts      # Mint処理ロジック
│   │   └── lib/
│   │       ├── solana.ts     # Solana/cNFT関連
│   │       ├── cnft.ts       # cNFT mint処理
│   │       ├── arweave.ts    # Arweave/Irys関連
│   │       └── database.ts   # Supabase保存処理
│   ├── package.json
│   └── Dockerfile
├── lens-worker/              # Cloudflare Worker (Lens機能)
│   ├── src/
│   │   └── index.ts          # Workers AI呼び出し
│   ├── wrangler.toml
│   └── package.json
├── shared/                   # 共有コード（型定義等）
│   └── types/
│       ├── index.ts
│       ├── job.ts            # MintJobData, MintJobResult
│       └── proof.ts          # ArweaveProofMetadata, MediaProof
└── redis-data/               # Redisの永続化データ（.gitignore）

```

---

## 🚀 開発ロードマップ

### ✅ MVP完成（Ver.5）- 2025年1月

**すべてのコア機能が実装済み・動作確認済み**

| カテゴリ | 機能 | 状態 |
| --- | --- | --- |
| **基盤** | Docker環境構築 | ✅ 完了 |
| | Redis + BullMQ（直列処理） | ✅ 完了 |
| | Privy認証（ウォレット接続） | ✅ 完了 |
| | R2二重バケット構成 | ✅ 完了 |
| **Blockchain** | cNFTアドレス予測 | ✅ 完了 |
| | Arweaveアップロード（Irys） | ✅ 完了 |
| | cNFT mint（BubbleGum） | ✅ 完了 |
| | 相互リンク検証（完全版・5ステップ） | ✅ 完了 |
| | Burn検出機能 | ✅ 完了 |
| | 所有権同期（Helius DAS API） | ✅ 完了 |
| **アップロード** | C2PA検証（WASM） | ✅ 完了 |
| | プライバシー警告表示 | ✅ 完了 |
| | アップロードフロー（5ステップ） | ✅ 完了 |
| | Worker側Mint処理 | ✅ 完了 |
| **アセット管理** | アセット詳細ページ（/asset/[hash]） | ✅ 完了 |
| | ダッシュボード（/dashboard） | ✅ 完了 |
| | ページネーション（20件/ページ） | ✅ 完了 |
| | アセット編集機能 | ✅ 完了 |
| | 公開/非公開切り替え | ✅ 完了 |
| **購入・決済** | SolanaPay購入フロー | ✅ 完了 |
| | トランザクション検証 | ✅ 完了 |
| | ダウンロード機能（トークン制） | ✅ 完了 |
| | 無料コンテンツ対応 | ✅ 完了 |
| **検索** | Lens機能（画像検索） | ✅ 完了 |
| | テキスト検索 | ✅ 完了 |
| | カメラ検索 | ✅ 完了 |
| | pgvectorベクトル検索 | ✅ 完了 |
| **UI/UX** | レスポンシブデザイン | ✅ 完了 |
| | ローディング状態表示 | ✅ 完了 |
| | エラーハンドリング | ✅ 完了 |

### 次フェーズ: 本番運用・改善

| カテゴリ | タスク | 優先度 |
| --- | --- | --- |
| **信頼性** | モニタリング・ログ基盤 | 🔴 高 |
| | エラー通知システム | 🔴 高 |
| | バックアップ戦略 | 🟡 中 |
| **パフォーマンス** | 画像最適化・CDN | 🟡 中 |
| | キャッシュ戦略 | 🟡 中 |
| | インデックス最適化 | 🟢 低 |
| **スケール** | マルチツリー対応 | 🟢 低 |
| | Worker並列化 | 🟢 低 |
| | 負荷分散 | 🟢 低 |
| **機能追加** | NFT譲渡履歴表示 | 🟡 中 |
| | コレクション機能 | 🟢 低 |
| | コメント機能 | 🟢 低 |

---

## 📚 参考資料

- [C2PA Technical Specification](https://c2pa.org/specifications/)
- [c2pa-rs GitHub](https://github.com/contentauth/c2pa-rs)
- [Metaplex Bubblegum](https://developers.metaplex.com/bubblegum)
- [Metaplex Umi](https://developers.metaplex.com/umi)
- [Helius DAS API](https://docs.helius.dev/compression-and-das-api/digital-asset-standard-das-api)
- [SolanaPay Specification](https://docs.solanapay.com/)
- [Privy Documentation](https://docs.privy.io/)
- [Cloudflare R2 Documentation](https://developers.cloudflare.com/r2/)
- [Cloudflare Workers AI](https://developers.cloudflare.com/workers-ai/)
- [Irys Documentation](https://docs.irys.xyz/)
- [BullMQ Documentation](https://docs.bullmq.io/)
- [Supabase pgvector](https://supabase.com/docs/guides/ai/vector-columns)